---
format:
  revealjs:
    theme: night
    transition: slide
editor: visual
execute:
  echo: true
---

::: {style="text-align: center;"}
# Entrega grupal

**Software para gestión de bases de datos**

[**Autores:** <a href="https://www.linkedin.com/in/almudena-moreno-ribera-5b1389233?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3BJxW49sp%2BS8WrZmgJWFAGSQ%3D%3D" target="_blank">Almudena Moreno Ribera</a> (DNI: 00000000-X) y <a href="https://www.linkedin.com/in/pablo-villoslada-blanco-5a4b2316a?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3B%2BykJQkDhTvqHG%2Bh5Ya24zA%3D%3D" target="_blank">Pablo Villoslada-Blanco</a> (DNI: 16615024-P)]{style="font-size: 20px;"}

<img src="./datos/imagen.png" style="max-width: 33%; height: auto; margin-top: 20px;"/>

[**Máster Universitario en Bioestadística, Universidad Complutense de Madrid (UCM), curso 2023/24**]{style="font-size: 15px;"}

::: {style="position: absolute; bottom: -30px; right: -570px;"}
<a href="https://github.com/pavillos/Entrega_grupal_SPGDBD" target="_blank"> <img src="./datos/github.png" alt="GitHub" style="max-width: 10%;"/> </a>
:::
:::

```{r}
#| echo: false

rm(list = ls()) # Borramos variables de environment
library(tidyverse)
library(skimr)
```

## Índice

1.  [Objetivo](#objetivo)

2.  [Carga de los datos](#carga)

3.  [Depuración de los datos](#depuracion)

4.  [Preguntas](#preguntas)

------------------------------------------------------------------------

## 1. Objetivo {#objetivo}

El objetivo de la entrega es realizar un análisis de las de citas electorales al Congreso de los Diputados de España desde 2008 hasta la actualidad, llevando a cabo la depuración, resúmenes y gráficos oportunos, tanto de sus resultados como del acierto de las encuestas electorales.

------------------------------------------------------------------------

## 2. Carga de los datos {#carga}

```{r}
datos_elecciones_brutos <- read_csv(file = "./datos/datos_elecciones_brutos.csv")
cod_mun <- read_csv(file = "./datos/cod_mun.csv")
encuestas_brutos <- read_csv(file = "./datos/historical_surveys.csv")
siglas <- read_csv(file = "./datos/siglas.csv")
```
```{r}
#| include: false 
datos_elecciones_brutos |> skim()
cod_mun |> skim()
encuestas_brutos |> skim()
siglas |> skim()
```

# 3. Depuración de los datos {#depuracion}

------------------------------------------------------------------------

## Índice

3.  [Depuración de los datos](#depuracion)

    3.1. [Eliminar variables que no aportan](#eliminar)

    3.2. [Convertir a tidy data](#tidy)

    3.3. [Añadir siglas](#siglas)

    3.4. [Filtrar los partidos](#filtrar)

    3.5. [Incluir la fecha de las elecciones y el nombre de los municipios](#incluir)

    3.6. [Filtrado de las encuestas de interés](#filtrado)

## 3.1. Eliminar variables que no aportan {#eliminar}

```{r}
datos_elecciones <- datos_elecciones_brutos |> 
  select(where(~ n_distinct(.) > 1))
encuestas <- encuestas_brutos |> 
  select(where(~ n_distinct(.) > 1))
```

------------------------------------------------------------------------

## 3.2. Convertir a tidy data {#tidy}

```{r}
datos_elecciones_tidy <- datos_elecciones |> 
  pivot_longer(cols = - ("anno":"votos_candidaturas"), names_to = "partido",
               values_to = "votos",
               values_drop_na = TRUE)
encuestas_tidy <- encuestas |> 
  pivot_longer(cols = -("date_elec":"turnout"),
               names_to = "siglas", 
               values_to = "intencion_voto",
               values_drop_na = TRUE)
```

------------------------------------------------------------------------

## 3.3. Añadir siglas {#siglas}

```{r}
datos_elecciones_tidy <- datos_elecciones_tidy |> 
  left_join(siglas, by = c("partido" = "denominacion"))

datos_elecciones_tidy <- datos_elecciones_tidy |> 
  relocate(siglas, .after = partido)

encuestas_tidy <- encuestas_tidy |> 
  left_join(siglas, by = c("siglas" = "siglas"))

encuestas_tidy <- encuestas_tidy |> 
  relocate(denominacion, .after = siglas)
```

------------------------------------------------------------------------

## 3.4. Filtrar los partidos {#filtrar}

```{r}
agrupar_siglas <- function(siglas, partido){
  siglas_comun <- case_when(
    
    # BLOQUE NACIONALISTA GALEGO (BNG)
    str_detect(str_to_upper(siglas), "BNG|B.N.G.") 
    ~ "BNG",
    
    # CONVERGÈNCIA I UNIÓ (CIU)
    str_detect(str_to_upper(siglas), "CIU") | 
      str_detect(str_to_upper(partido), "CONVERGÈNCIA I UNIÓ")
    ~ "CIU",
    
    # COMPROMÍS
    (str_detect(str_to_upper(siglas), "COMPROMÍS|COMPROMIS|VERDS") | 
     str_detect(str_to_upper(partido), "COMPROMÍS")) & 
     !str_detect(str_to_upper(partido), "MÉS COMPROMÍS")
    ~ "COMPROMIS",
    
    # CIUDADANOS (Cs) (cuidado: tiene/tuvo federaciones - sucursales - con algún otro nombre)
    str_detect(str_to_upper(siglas), "CS") | 
      str_detect(str_to_upper(partido), "CIUDADANOS PARTIDO DE LA|CIUDADANOS,|CIUDADANOS-|CIUTADANS")
    ~ "CS",
    
    # EH - BILDU (son ahora una coalición de partidos formados por Sortu, Eusko Alkartasuna, Aralar, Alternatiba)
    str_detect(str_to_upper(siglas), "EH|AMAIUR|ARALAR") | 
      str_detect(str_to_upper(partido), "EUSKO ALKARTASUNA|EUSKAL HERRIA BILDU|PARTIDO POLITICO ARALAR")
    ~ "EH-BILDU",
    
    # ESQUERRA REPUBLICANA DE CATALUNYA (ERC)
    (str_detect(str_to_upper(siglas), "ERC|ESQUERRA") | 
     str_detect(str_to_upper(partido), "ESQUERRA REPUBLICANA")) & 
      !str_detect(str_to_upper(partido), "PAIS VALENCIA|PAÍS VALENCIÀ")
    ~ "ERC",
    
    # MÁS PAÍS
    str_detect(str_to_upper(siglas), "MÁS PAÍS|MP|M PAÍS") & 
    !str_detect(str_to_upper(partido), "MÉS COMPROMÍS")
    ~ "MÁS PAÍS",
    
    # PARTIDO NACIONALISTA VASCO (PNV)
    str_detect(str_to_upper(siglas), "PNV|P.N.V.") 
    ~ "PNV",
    
    # PARTIDO POPULAR (PP)
    ((str_detect(str_to_upper(siglas), "PP|AP|PDP") | 
     str_detect(str_to_upper(partido), "PARTIDO POPULAR|UNIÓN DEL PUEBLO NAVARRO EN COALICIÓN CON EL PARTI")) & 
      !str_detect(str_to_upper(partido), "ARA,|ANTICAPITALIST|PARTIDO POSITIVISTA CRISTIANO|PLATAFORMA DEL PUEBLO SORIANO"))
    ~ "PP",
    
    # PARTIDO SOCIALISTA OBRERO ESPAÑOL (cuidado: tiene/tuvo federaciones - sucursales - con algún otro nombre)
    str_detect(str_to_upper(siglas), "PSOE|PAD|PSC") | 
     str_detect(str_to_upper(partido), "PARTIDO SOCIALI|PSOE|PARTIT SOCIALISTA OBRER ESPANYOL")
    ~ "PSOE",
    
    # UNIDAS PODEMOS - IU (cuidado que aquí han tenido nombres variados - 
    # IU, los verdes, podem, ezker batua, …- y no siempre han ido juntos, 
    # pero aquí los analizaremos juntos (UP-IU)
    ((str_detect(str_to_upper(siglas), "IU|LV|PODEMOS|UP|VERDES|CANARIAS DE") | 
      str_detect(str_to_upper(partido), "ELS VERDS|PODEM|EN MAREA|EQUO|PODEMOS|ESQUERDA UNIDA|ESQUERRA UNIDA|EZKER BATUA|OS VERDES|IZQUIERDA UNIDA")) & 
       (!str_detect(str_to_upper(siglas), "CUP|EN POSITIU|EL PI|UPYD|RECORTES CERO-GRUPO VERDE|UPD|UPL") |
        !str_detect(str_to_upper(partido), "EN POSITIU|EL PI|MOVIMIENTO POR LA UNIDAD DEL PUEBLO CANARIO|RECORTES CERO|RECORTES CERO-GRUPO VERDE|UNION DEL PUEBLO LEONES|N PROGRESO Y DEMOCRACIA")))
    ~ "UP-IU",
    
    # VOX
    str_detect(str_to_upper(siglas), "VOX") ~ "VOX",
    
    # OTROS
    TRUE ~ "OTROS")
  
  return(siglas_comun)
}

datos_elecciones_tidy <- datos_elecciones_tidy |>
  mutate(siglas_comun = agrupar_siglas(siglas, partido))

encuestas_tidy <- encuestas_tidy |>
  mutate(siglas_comun = agrupar_siglas(siglas, denominacion))
```

------------------------------------------------------------------------

## 3.5. Incluir la fecha de las elecciones y el nombre de los municipios {#incluir}

```{r}
datos_elecciones_tidy <- datos_elecciones_tidy |> 
  mutate(fecha = glue::glue("{anno}-{mes}"),
         id_mun = glue::glue("{codigo_ccaa}-{codigo_provincia}-{codigo_municipio}")) |>
  left_join(cod_mun, by = c("id_mun" = "cod_mun"))
```

## 3.6. Filtrado de las encuestas de interés {#filtrado}

Descartar todas aquellas encuestas que hagan referencia a elecciones anteriores a 2008, que sean a pie de urna, que tenga un tamaño muestral inferior a 750 o que sea desconocido que tengan menos de 1 o menos días de trabajo de campo

```{r}
encuestas_tidy |> 
  drop_na(size) |> 
  mutate(dias_trabajo = field_date_to - field_date_from, .after = field_date_to) |> 
  filter(year(date_elec)>=2008 & exit_poll & size > 750) |> 
  select(-exit_poll)
```

# 4. Preguntas {#preguntas}

------------------------------------------------------------------------

## ¿Cómo se reparte el voto de partidos de ámbito nacional (PSOE, PP, VOX, CS, MP, UP - IU) frente a los partidos de corte autonómico o nacionalista?

------------------------------------------------------------------------

## ¿Cuál el partido ganador en los municipios de más de 100 000 habitantes de censo en cada una de las elecciones?

------------------------------------------------------------------------

## ¿Qué partido fue el segundo cuando el primero fue el PSOE? ¿Y cuándo el primero fue el PP?

------------------------------------------------------------------------

## ¿En qué municipios de más 2000 habitantes de censo, provincias o autonomías la diferencia entre el ganador y el segundo es más elevada?

------------------------------------------------------------------------

## ¿Cuáles son los municipios con mayor porcentaje de votos nulos de España?

------------------------------------------------------------------------

## ¿En qué sitios hay mayor participación? ¿Quién ganó en los sitios con mayor participación y donde menos? ¿A quién le beneficia la baja participación?

------------------------------------------------------------------------

## ¿Cómo analizar la relación entre censo y voto? ¿Es cierto que ciertos partidos ganan lo rural?

------------------------------------------------------------------------

## ¿Cómo calibrar el error de las encuestas? ¿Cómo visualizarlo? (recuerda que las encuestas son intención de voto a nivel nacional).

------------------------------------------------------------------------

## ¿En qué elección se equivocaron más las encuestas?

------------------------------------------------------------------------

## ¿Cómo se equivocaron las encuestas en partidos de ámbito nacional (PSOE, PP, VOX, CS, MP, UP - IU).

------------------------------------------------------------------------

## ¿Qué casas encuestadores acertaron más y cuales se desviaron más de los resultados?

::: {style="text-align: center;"}
# Entrega grupal

**Software para gestión de bases de datos**

[**Autores:** <a href="https://www.linkedin.com/in/almudena-moreno-ribera-5b1389233?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3BJxW49sp%2BS8WrZmgJWFAGSQ%3D%3D" target="_blank">Almudena Moreno Ribera</a> (DNI: 00000000-X) y <a href="https://www.linkedin.com/in/pablo-villoslada-blanco-5a4b2316a?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3B%2BykJQkDhTvqHG%2Bh5Ya24zA%3D%3D" target="_blank">Pablo Villoslada-Blanco</a> (DNI: 16615024-P)]{style="font-size: 20px;"}

<img src="./datos/imagen.png" style="max-width: 33%; height: auto; margin-top: 20px;"/>

[**Máster Universitario en Bioestadística, Universidad Complutense de Madrid (UCM), curso 2023/24**]{style="font-size: 15px;"}

::: {style="position: absolute; bottom: -30px; right: -570px;"}
<a href="https://github.com/pavillos/Entrega_grupal_SPGDBD" target="_blank"> <img src="./datos/github.png" alt="GitHub" style="max-width: 10%;"/> </a>
:::
:::
